#!/usr/bin/python

import sys
import os
import time
import getopt
import locale

import lastfm
import lastfm.logger
import lastfm.queue
import lastfm.marshaller

USAGE = """\
usage: lastfmsubmitd [--encoding ENC] [--artist ARTIST] [--title TITLE]
    [--length LEN] [--time STAMP] [--album ALBUM] [--mbid TRACKID]
    [--output FILE] [--debug] [--quiet] [--help]"""

if __name__ == '__main__':
    os.umask(002)

    shortopts = 'a:s:l:d:b:m:o:e:dqh'
    longopts = [
        'artist=',
        'title=',
        'length=',
        'time=',
        'album=',
        'mbid=',
        'output=',
        'encoding=',
        'debug',
        'quiet',
        'help',
        ]

    try:
        opts, args = getopt.getopt(sys.argv[1:], shortopts, longopts)
    except getopt.GetoptError, e:
        print >>sys.stderr, 'lastfmsubmit: %s' % e
        print >>sys.stderr, USAGE
        sys.exit(1)

    sub = {}
    outfile = lastfm.FIFO
    encoding = locale.getpreferredencoding()
    debug = False
    err = True
    lock = lastfm.FIFO

    for opt, arg in opts:
        if opt in ('--encoding', '-e'):
            encoding = arg
        if opt in ('--debug', '-d'):
            debug = True
        if opt in ('--quiet', '-q'):
            err = False

    try:
        log = lastfm.logger.getlog('lastfmsubmit', lastfm.LOG, debug, err)
    except IOError, e:
        print >>sys.stderr, 'lastfmsubmit: error opening log: %s' % e
        sys.exit(1)

    try:
        for opt, arg in opts:
            try:
                if opt in ('--artist', '-a'):
                    sub['artist'] = lastfm.marshaller.guess_enc(arg, encoding)
                elif opt in ('--title', '-t'):
                    sub['title'] = lastfm.marshaller.guess_enc(arg, encoding)
                elif opt in ('--length', '-l'):
                    sub['length'] = lastfm.marshaller.parse_length(arg)
                elif opt in ('--time', '-i'):
                    sub['time'] = time.strptime(arg, lastfm.TIME_FMT)
                elif opt in ('--album', '-b'):
                    sub['album'] = lastfm.marshaller.guess_enc(arg, encoding)
                elif opt in ('--mbid', '-m'):
                    sub['mbid'] = arg
                elif opt in ('--output', '-o'):
                    outfile = arg
                    lock = None
                elif opt in ('--help', '-h'):
                    print USAGE
                    sys.exit(0)
            except ValueError:
                print >>sys.stderr, "lastfmsubmit: can't parse %s" % opt
                sys.exit(1)

        if len(sub) == 0:
            print >>sys.stderr, "lastfmsubmit: nothing specified"
            print >>sys.stderr, USAGE
            sys.exit(1)
        if not sub.has_key('time'):
            sub['time'] = time.gmtime()

        if outfile == '-':
            print lastfm.marshaller.dump(sub)
        else:
            try:
                out = lastfm.queue.Writer(log, outfile, lock)
                print >>out, lastfm.marshaller.dump(sub)
                log.debug('Sent %s to daemon' % lastfm.logger.repr(sub))
            except IOError:
                log.error("Can't write to %s" % outfile)
                sys.exit(1)

    except SystemExit, e:
        sys.exit(e.args[0])
    except:
        import traceback
        einfo = traceback.format_exception(*sys.exc_info())
        log.error('Aborting: %s' % ''.join(einfo))
        sys.exit(1)
